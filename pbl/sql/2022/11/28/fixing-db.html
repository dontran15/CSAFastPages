<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Fixing Database Error</h1><p class="page-description">Fixing error caused in transaction due to id generation method in database</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-11-28T00:00:00-06:00" itemprop="datePublished">
        Nov 28, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Don Tran</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      1 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/CSAFastPages/categories/#pbl">pbl</a>
        &nbsp;
      
        <a class="category-tags-link" href="/CSAFastPages/categories/#sql">sql</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/dontran15/CSAFastPages/tree/master/_notebooks/2022-11-28-fixing-db.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/CSAFastPages/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/dontran15/CSAFastPages/master?filepath=_notebooks%2F2022-11-28-fixing-db.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/CSAFastPages/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/dontran15/CSAFastPages/blob/master/_notebooks/2022-11-28-fixing-db.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/CSAFastPages/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fdontran15%2FCSAFastPages%2Fblob%2Fmaster%2F_notebooks%2F2022-11-28-fixing-db.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/CSAFastPages/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Error">Error </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Relationships">Relationships </a></li>
<li class="toc-entry toc-h3"><a href="#Database-Locking">Database Locking </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Fix">Fix </a>
<ul>
<li class="toc-entry toc-h3"><a href="#ID-generation-using-IDENTITY">ID generation using IDENTITY </a></li>
<li class="toc-entry toc-h3"><a href="#AutoIncreament">AutoIncreament </a></li>
<li class="toc-entry toc-h3"><a href="#Successful-Database-Write">Successful Database Write </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-11-28-fixing-db.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Error">
<a class="anchor" href="#Error" aria-hidden="true"><span class="octicon octicon-link"></span></a>Error<a class="anchor-link" href="#Error"> </a>
</h2>
<h3 id="Relationships">
<a class="anchor" href="#Relationships" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relationships<a class="anchor-link" href="#Relationships"> </a>
</h3>
<p>OneToMany relationship and ManyToOne relationship stores POJOs in separate tables which are tied by one table that stores the relationship between using their respective ids. (In this case I used StepLog instead of Day because I thought it might've been a more appropriate name)</p>
<p><img src="https://user-images.githubusercontent.com/75715248/204440921-f752729c-8371-4d0a-95c9-670d4af1a966.png" alt="">
<img src="https://user-images.githubusercontent.com/75715248/204440990-c5a33508-e734-4870-b797-0d634ec0abc6.png" alt="">
<img src="https://user-images.githubusercontent.com/75715248/204441053-12ef2a29-9867-45a9-be62-defb791673ff.png" alt=""></p>
<h3 id="Database-Locking">
<a class="anchor" href="#Database-Locking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database Locking<a class="anchor-link" href="#Database-Locking"> </a>
</h3>
<p>The issue is that SQL's implementation of autogenerated ids comes from hibernate_sequence which is a global table so when a request to pull a value from the table is processed, SQL locks the entire database. So, when a step log is created, JPA requests to generate an id for the newly created steplog which causes the entire database to become locked and in turn prevent the following request to update the person_step_log table from being updated. This results in the transaction failing which rolls back all changes.</p>
<p><img src="https://user-images.githubusercontent.com/75715248/204443080-337a2551-af2f-471e-9417-8d53e9fa1298.png" alt=""></p>
<h2 id="Fix">
<a class="anchor" href="#Fix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fix<a class="anchor-link" href="#Fix"> </a>
</h2>
<h3 id="ID-generation-using-IDENTITY">
<a class="anchor" href="#ID-generation-using-IDENTITY" aria-hidden="true"><span class="octicon octicon-link"></span></a>ID generation using IDENTITY<a class="anchor-link" href="#ID-generation-using-IDENTITY"> </a>
</h3>
<p>One fix was to use a separate id generation method independent of the hibernate_sequence table used to automatically generate ids. To do this, you can change the id generation method for StepLog to IDENTITY.</p>
<p><img src="https://user-images.githubusercontent.com/75715248/204443214-00e88e5a-d2bf-4d03-9caf-f45cf7ce2822.png" alt=""></p>
<h3 id="AutoIncreament">
<a class="anchor" href="#AutoIncreament" aria-hidden="true"><span class="octicon octicon-link"></span></a>AutoIncreament<a class="anchor-link" href="#AutoIncreament"> </a>
</h3>
<p>This enables you to use SQL's AutoIncreament feature as your id generation method. 
<img src="https://user-images.githubusercontent.com/75715248/204444678-1c58486c-d2ec-4058-b571-a6d9ce3c7c3d.png" alt="">
<img src="https://user-images.githubusercontent.com/75715248/204444838-d869d854-bb92-401d-ab16-a89f464089e5.png" alt=""></p>
<h3 id="Successful-Database-Write">
<a class="anchor" href="#Successful-Database-Write" aria-hidden="true"><span class="octicon octicon-link"></span></a>Successful Database Write<a class="anchor-link" href="#Successful-Database-Write"> </a>
</h3>
<p>Thus, no request is needed/made which locks the database and therefore allows the relationship to be written into the person_step_log table.</p>
<p><img src="https://user-images.githubusercontent.com/75715248/204445020-c27e588f-6da0-4e2c-a292-bd3d158488db.png" alt="">
<img src="https://user-images.githubusercontent.com/75715248/204445130-1c5dc268-bb6e-4304-852e-e65355b93546.png" alt=""></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/CSAFastPages/pbl/sql/2022/11/28/fixing-db.html" hidden></a>
</article>
